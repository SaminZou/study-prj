```yaml
title: 日志打印Tips 
author: samin
date: 2021-09-23
```

# 选择正确的日志级别

常见的日志级别有5种，分别是error、warn、info、debug、trace

- error 错误日志，指比较严重的错误，对正常业务有影响，需要运维配置监控的

- warn 警告日志，一般的错误，对业务影响不大，但是需要开发关注

- info 信息日志，记录排查问题的关键信息，如调用时间、出参入参等等

- debug 用于开发DEBUG的，关键逻辑里面的运行时数据

- trace 最详细的信息，一般这些信息只记录到日志文件中

# 打印入出参

需要打印可以快速定位问题的**有效日志**，打印出参，返回值的关键数据

入参的话，一般就是userId或者bizSeq这些关键信息

# 方便排查的日志格式

理想的日志格式，应当包括这些最基本的信息：如当前时间戳（一般毫秒精确度）、日志级别，线程名字等等

# 分支代码打印日志

if...else...或者switch这样的条件时，可以在分支的首行就打印日志，这样排查问题时，就可以通过日志，确定进入了哪个分支，代码逻辑更清晰，也更方便排查问题了

# 日志级别比较低时，进行日志开关判断

# 不能直接使用日志系统（Log4j、Logback）中的 API，而是使用日志框架SLF4J中的API

```java
if(isDebugger){
    log.debugger("debugger log");    
}
```

# 建议使用参数占位{}，而不是用+拼接

使用了大括号{}来作为日志中的占位符，比于使用+操作符，更加优雅简洁。并且，相对于反例，使用占位符仅是替换动作，可以有效提升性能

# 建议使用异步的方式来输出日志

例如 logback 框架可以使用 AsyncAppender 来异步输出日志

# 不要使用e.printStackTrace()


- e.printStackTrace()打印出的堆栈日志跟业务代码日志是交错混合在一起的，通常排查异常日志不太方便。
 
- e.printStackTrace()语句产生的字符串记录的是堆栈信息，如果信息太长太多，字符串常量池所在的内存块没有空间了,即内存满了，那么，用户的请求就卡住啦

# 异常日志不要只打一半，要输出全部错误信息

需要全量打印 e

# 禁止在线上环境开启 debug

# 不要记录了异常，又抛出异常

log 之后不需要再进行 throw

# 避免重复打印日志

# 日志文件分离


- 可以把不同类型的日志分离出去，比如access.log，或者error级别error.log，都可以单独打印到一个文件里面
 
- 可以根据不同的业务模块，打印到不同的日志文件里，这样我们排查问题和做数据统计的时候，都会比较方便啦

# 核心功能模块，建议打印较完整的日志

- 我们日常开发中，如果核心或者逻辑复杂的代码，建议添加详细的注释，以及较详细的日志

- 日志要多详细呢？脑洞一下，如果你的核心程序哪一步出错了，通过日志可以定位到，那就可以啦

# 日志分类

- 系统日志

系统日志主要是为开发排查问题提供依据，一般打印在日志文件中；系统日志的可读性要求没那么高，日志中会包含代码的信息，比如在某个类的某一行打印了一个日志。

- 操作日志

主要是对某个对象进行新增操作或者修改操作后记录下这个新增或者修改，操作日志要求可读性比较强，因为它主要是给用户看的，比如订单的物流信息，用户需要知道在什么时间发生了什么事情。再比如，客服对工单的处理记录信息。

# 使用统一的记录对象

## 参数

- traceId: 调用链id（如果应用中已经使用了统一调用链监控方案，且能根据调用链id查询接口情况的，可以不用在代码里手动加入traceId。如果应用还没接入调用链系统，建议加一下traceId，尤其是针对聚合服务，需要调用中台各种微服务接口的）

- eventName: 事件名称,一般就是业务方法名称

- userId: C端用户id

- msg: 结果消息

- costTime: 接口响应时间

- request: 接口请求入参

- response: 接口返回值

- others: 其他业务参数

## 注意

1. 一般使用构造器方式，链式方法方便调用

2. request 和 response 放在同一个类里面，方便排查，使用两个类还要额外的关联以及在加载的时候费时

## 示例

```java
@Jacksonized
@Getter
@ToString
@Setter
@SuperBuilder
public class LogRecord {

    /**
     * 调用链id
     */
    private Long traceId;
    
    /**
     * 事件名称，方法名
     */
    private String eventName;

    /**
     * C端用户id
     */
    private Long userId;

    /**
     * 结果消息
     */
    private String msg;

    /**
     * 接口响应时间
     */
    private String costTime;

    /**
     * 接口请求入参
     */
    private String request;

    /**
     * 接口返回值
     */
    private String response;

    /**
     * 其他业务参数
     */
    private String others;
}
```

# 日志系统的搭建

- 日志收集

- 日志分析

- 通过日志发出告警信息

- 日志搜索

- 日志监控