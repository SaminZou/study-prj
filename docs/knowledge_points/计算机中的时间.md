```yaml
title: 计算机中的时间
author: samin
date: 2021-07-14
```

# 为什么计算机的时间有时候「不准」？

钟表和计算机内部都有一个叫做「晶体振荡器」的东西，给它加上电压，它就会以固定的频率振动。但这个振动频率的「稳定性」，取决于它的制造工艺，以及外界环境的影响。

出于成本的考虑，钟表的制作工艺没那么高，所以它更容易有误差。而电脑制造工艺虽然比较高，但它内部的晶体振荡器也会受到「温度」变化带来的影响，在工作过程中，也会有产生误差。

虽然它们的误差很小，但日积月累下来，误差就越来越明显。

因此，我们现在使用的计算机，都有「自动校准」时间的功能。

> 没有联网的计算机，关机后，并没有完成停止工作，内置主板有电池继续在计算时间，所以开机后才能保持时间的准确

# 计算机如何「自动校准」时间的？

使用网络请求指定的时间服务器，通过 NTP（网络时间协议）同步本地系统时间

> 网络通信有时间差，同步的时间也有损耗

# 我们经常看到的 UTC 时间，到底是什么？

人们以基于「天文现象」+「钟表计时」，确立了第一套时间标准：世界时（Universal Time，简称 UT）

> 依赖于天文现象观测一秒的时间，随着各种自然现象，发现秒的时间并不准确

## 一秒有多长

随着人类活动的发展，人们对于高精度的时间场景开始变得越来越多。例如，体育赛事中百分之一秒的差距就能决定胜负，炮弹的发射要精确在千分之一秒内发生，雷达技术甚至需要精确到百万分之一秒

对于「秒」的定义需求，从本质上讲，就是想要一个「完全稳定」的周期，也就是说，期望每一秒都是固定「等长」的

铯原子，它内部的振荡周期比其它原子都要更短、更稳定，而且，这个过程基本不受环境因素的干扰。经过层层试验，科学家们认为这是目前人类在地球上可测量到的，运动周期最短、周期最稳定的元素！

之后，科学家们就以之前定义的「秒」为基础，去测量一秒内这个铯原子内部电子周期运动的「次数」，测量出来的结果为 9192631770 次（91 亿+次）。

基于此，科学家们决定「抛弃」原来基于**天文测量**的秒，重新定义「秒」的时长，就是这个高度稳定的运动周期。在 1967 年，国际度量衡大会决定采用，以**铯原子跃迁 9192631770 个周期**，所持续的时间长度定义为 1 秒！

铯原子振荡制造出来的时钟，我们就把它称之为「原子钟」。有了原子钟，这就意味着，原子钟输出的每一秒，都是绝对「等长」的，非常稳定，这样一来，就实现了「精准计时」！

人们基于原子钟又确立了一套新的时间标准，叫做「国际原子时」（International Atomic Time，简称 TAI）。科学家们规定，从 1958-01-01 00:00:00 起，用原子时开始计时，它每走的一秒，都是非常精确的一秒（固定等长），实打实的一秒，完全稳定的一秒。

# 世界标准时间是怎么来的

科学家制定出了两套时间标准：
1. 世界时（UT）：`基于天文现象 + 钟表计时`，永远与地球自转时间相匹配
2. 国际原子时（TAI）：基于`原子钟计时`，每一秒的周期完全等长且固定

> 因为原子时准确，世界时偏慢，所以长期的结果就会是在若干年后，相差时间为同一时间，一个为白天，一个是晚上，颠覆我们的认知

两套时间标准都很重要，那两者都保留，不会互相取代。我们可以再建立一套「新的时间标准」，这套时间以「原子时为基准」，开始计时，走的每一秒都是稳定、精确的。

同时，为了兼顾基于天文测量的世界时，人类会「持续观测」世界时与这个新时钟的差距。如果发现两者相差过大时，我们就「人为」地调整一下这个时钟（加一秒或减一秒），让两者相差不超过 0.9 秒。

例如，这个时钟本身比世界时走得快，经过一段时间后，如果发现两者相差越来越大，那就给这个时钟「加一秒」，让这个时钟在 23:59:59 的下一秒变为 23:59:60 秒，让它与世界时差距控制在 0.9 秒以内，这个操作过程，相当于让快的时钟稍微「等」一下走得慢的世界时。
而加的这一秒，科学家把它定义为**「闰秒」**。

由于这个时钟是基于原子时 + 世界时「协调」得出的，所以科学家们把它定义为协调世界时（Coordinated Universal Time，简称 UTC）

全新的世界标准时间确立了，这套时间标准于 1972 年正式确定，一致沿用至今。

> 北京时间的产生在陕西省（在我国中部，达到各个省份时间比较平均），由 UTC 加上 8 小时时区差而成

# 授时

位于陕西省的中国科学院国家授时中心，产生北京时间后，会通过一系列方式，把这个时间广播出去，这个过程，就叫做「授时」。
具体怎么做呢？

国家授时中心提供很多授时方式，例如无线电波、网络、电话，都可以把时间广播出去。

无线电波的传播速度更快、传播误差小，所以授时中心会通过这种方式，把时间发送给全国各地的「时间服务器」

当计算机在做时间校准时，也需要把网络延迟计算进去，最后「修正」这个同步过来的时间，降低误差。

## NTP

部署应用程序的服务器上，都会启动一个「自动校准」时间的服务，这个服务就是 NTP（Network Time Protocol），它可以保证每台机器的时间与时间服务器保持同步。

### 同步的时候，会计算网络延时

### 同步时间可能对程序执行造成影响

```

t1 = time.now()

// 时间校准

t2 = time.now()

diff = t2 - t1

```

可能出现 t2 比 t1 小的情况，也就是时间「倒流」现象，需要知道以下两个时钟：

- 墙上时钟：通常就是指前面讲到的世界协调时 UTC，校准时间后，可能发生校准
  
- 单调时钟：计算机自启动以后经历的纳秒数，不会发生校准

一般我们写的代码，像上面程序调用的「时间 API」，通常获取的时间是墙上时钟，所以，如果时间发生校准，就可能会发生「倒流」现象

NTP 在校准时间时，提供了 2 种方式避免这种现象的发生：

1. ntpdate：一切以服务端时间为准，「强制修改」本机时间
   
2. ntpd：采用「润物细无声」的方式修改本机时间，把时间差均摊到每次小的调整上
   ntpd 当接收到需要「校准」时间时，会让本机时间走得「慢」一点，小步调整，逐渐与服务端的时钟「对齐」，这样一来，本机时间依旧是递增的，避免发生「倒流」