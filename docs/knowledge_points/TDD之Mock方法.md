```yaml
title: TDD之Mock方法
author: samin
date: 2021-03-23
```

# 术语解释

- SUT ( Software Under Test )

测试对象

- 打桩

创建 mock 桩，指定 API 请求内容及其映射的 mock 响应内容

- 调桩

被测服务来请求 mock 桩并接收 mock 响应

# 背景

我们通常测试 SUT 的时候， SUT一般会依赖很多其他对象，在单元测试中，往往这些被依赖的对象需要被实例化，这个行为成为Mock。

# 分类

## 方法

面向类里面的具体方法

## 类

面向某个类

## 接口

面向类组成的一个接口

## 服务

面向多个接口组成的一个具体服务

> 按照集成程度比较：方法 < 类 < 接口 < 服务

# 注入

## 什么是 mock 注入

mock 的本质就是用模拟桩来替换真实的依赖。所谓 mock 桩注入就是阻断被测服务与真实服务之间的链路，建立被测服务与 mock 之间的链路过程

## 如何注入 mock

总的来说 mock 桩的注入方式与架构、被测服务的架构等因素相关

# 注入方式

- API 请求构造

在 mock 接口中被测服务是 API 的请求方，即客户端；依赖服务是 API 的响应方，即服务端。根据 mock 工作的位置，mock 可以分为客户端 mock 和服务端 mock

- 本地配置

对于服务端 mock，打桩之后会生成唯一的 mock 桩地址。被测服务要想调用这个桩需要知道桩地址，如何让被测服务知道桩地址呢？一种最直接的方法就是被测服务提供一个依赖服务地址配置项，在需要使用 mock 时将依赖服务地址修改成 mock 地址。
本地配置的优势是实现简单，不足之处是修改配置项需要重启被测服务，在需要进行 mock 服务与真实服务切换时不方便。

- 配置中心

在服务端 mock 中，为了避免修改依赖服务地址配置项导致被测服务重启，可以采用配置中心（如 Spring Cloud Config Server）存储和管理依赖服务地址配置，或者使用注册中心（如 Spring Cloud Eureka）记录服务与服务地址的映射关系。

使用配置或者注册中心时，mock 注入的方法是修改配置中心，将依赖服务地址改成 mock 地址。这种注入方法不需要重启被测服务，但是从配置改变到配置生效可以存在一定的延时。

- 反向代理

在微服务架构下，被测服务与依赖服务之间可能不是直连的，而是经过了一层反向代理，例如 API 网关。在这种情况下，被测服务是通过调用 API 网关来间接调用依赖服务的接口。

在 API 网关模式下，mock 注入的具体做法就是修改 API 网关配置，将依赖服务 API 网关接口绑定的地址改成 mock 地址。

这种注入的优势是对被测服务无侵入，并且实现更细粒度（接口级）的 mock。当然，根据 API 网关的实现不同，仍然可能存在一定的时延。亚马逊 AWS 的 API 网关就是采用这种方式进行 mock。

- 前向代理

服务端 mock 除了作为 HTTP 服务器，还可以兼备 HTTP 代理的功能，这种架构又叫做 mock 代理，例如 mock server proxy。对于 mock 代理来说，它不仅能够返回 mock 响应，而且能够在需要的时候将 API 请求转发给依赖服务，并将依赖服务的真实响应返回给被测服务。

使用前向代理模式，mock 注入的方式是将被测服务的依赖地址或网络代理修改为 mock 地址，这种注入方法需要重启被测服务，其优势是能够实现细粒度的 mock，并且能够根据录制的真实响应自动生成 mock。

# mock的两个技巧

- 记录真实的调用信息 
  
- 生成模拟的返回信息

# Mock 工具

## 单元测试级别

- easymock
  
- jMock
  
- Mockito
  
- Unitils Mock
  
- PowerMock
  
- JMockit

## 接口测试级别


- Wiremock

- Mockserver

- Moco

- Mock.js

- RAP

