```yaml
title: IoT 平台入门
author: samin
date: 2021-11-17
```

# 物联网平台是什么

## 平台是什么

平台是提供作为可消费解决方案的加速器而现成的底层领域模型及功能系统。

## 物联网平台

物联网中台( IoT-Middle-Platform,IMP) 这个词是我结合物联网基础平台概念和现在很火的中台概念创造出来的一个词，在本文的上下文中，物联网中台(IMP)是一个具有基础级功能的软件产品，开发团队使用它来构建可消费的软件应用程序。你需要做一些开发工作来构建一个上层应用系统。

# IoT 市场

## 现状

市面上有大量不同功能和规模的物联网平台，随着 5G 等技术的发展继续增长。

## 为什么要构建自己的物联网平台

- 决定发展的上限（根据业务定制）

- 云物联网平台使用价格高昂（基于流量或者设备数进行收费）

## 物联网平台类型

- 物联网网络支撑平台
  这些平台主要提供网络层的支持(可以参考物联网技术栈之通信服务)，如MAC层通信解码和转换、身份和密钥管理、网络流量及费用管理等。这些平台主要由电信运营商提供和运营。我们的三大运营商都有这个层面的IoT平台。当然，运营商们怀揣着这么得天独厚的物联网资源也不想浪费，所以在他们平台上也大都扩展了网络支撑之外的平台级能力。

> 移动 OneNET 平台；联通物联网平台；电信物联网平台

- 基于网络和应用之间的物联网支撑平台(物联网中台)
  这类平台支持处理网络接入和数据预处理，如系统级协议解码、转换、解码等。可以控制、协调协议和处理流程规则编排。还支持数据存储及设备管理等功能。我们可以把它们当作系统的核心管道，这也是我们在本系列文章中要构建的平台。这类平台有时也会叫做物联网中间件平台。

- 物联网应用平台
  这类平台主要为物联网的业务平台，是最终的业务价值体现，如智慧楼宇、智慧医疗等行业级产品，或基于物联网的企业内部的ERP或CRM产品。这类产品一般会基于网络支撑平台和物联网中台之上进行构建。

## 好的物联网平台需要具备的能力

- 可伸缩性

- 可靠性

- 可定制

- 丰富的协议和接口

- 硬件兼容
  物联网本质上是一组异构的互联、硬件设备、计算机系统和软件。这使得硬件不可知的要求几乎显而易见。许多人认为硬件是传感器的集成电路，因此，我们认为物联网平台应该不知道您在电路中使用的是什么电子产品。无论是开源硬件设计、专有电路还是混合电路，平台都应该能够支持它。

- 云兼容
  类似于硬件兼容，平台也需要云兼容。有几个云服务提供商，包括国内的阿里云、华为云、腾讯云。国外的Google、Microsoft和Amazon Web服务（AWS），但是这个平台不应该依赖于云。无论是你自己的服务还是运行在NAS（网络连接存储）后面的第三方云，该平台都应该能够工作。如果你在一个虚拟的私有服务器实例上安装这个平台，它会工作吗？答案应该是一个简单的“是”，这意味着物联网平台与云无关。

- 架构和技术栈可演进

- 安全

- 成本

- 运维与支持
  尽管对平台管理的运维与支持是必不可少的，但解决方案集成也需要支持。作为一项强制性的要求，中间件平台应该在解决方案的设计、开发、部署和管理方面持续提供强大的运维和支持能力。

# 物联网平台架构

## 物联网解决方案

- 设备
  设备管理

- 网关
  设备接入

- 物联网平台
  数据采集、数据存储、设备联动、指令下发

- 物联网应用
  报表、告警通知

## 物联网平台架构

![物联网平台架构](https://raw.githubusercontent.com/SaminZou/pic-repo/master/IoT/物联网平台架构.png)

### 边缘接口、消息代理和消息总线模块

这个模块连接物理世界：主要是异构设备、传感器和网关。由于设备可以通过多种通信技术进行通信，如Wi-Fi、蓝牙、LoRaWAN、GPRS等，因此该模块需要满足所有这些技术要求。我们可以用模块化的方式来实现，其中每种类型的通信协议都是单独实现的。例如，支持Wi-Fi的设备可以是REST API，它也可以是基于MQTT的消息代理，支持以发布/订阅方式进行通信。

该模块有效地将整个平台与设备解耦。现代物联网设备支持许多边缘接口和协议。无论使用何种通信媒介、网络类型和协议，消息代理的工作都是以统一的方式整合数据并将其推送到公共消息总线。所有其他模块共享消息总线进行进一步操作。代理充当消息的协调器和合并器。

### 消息路由和通信管理模块

一旦消息发送到消息总线，消息需要加入更多上下文信息，以便其他模块识别和处理。通信管理模块的工作是丰富化现有的数据消息，并将其重新广播到消息总线，在消息到达后附加上下文信息和其他消息来标记它们。通信管理功能与消息代理和规则引擎块协调，根据需求与设备管理模块交互。

此外，通信管理模块执行格式转换的任务；例如，它将数据从CSV转换为JSON，或将二进制转换为文本格式。我们还可以让它执行某些操作，如数据去重，数据去重是从设备中消除或丢弃多个重复消息或冗余数据包的过程，因为它们可能没有任何用处。数据去重取决于设备或传感器类型，我们需要根据具体情况来实现。作为通信路由，该模块可以进一步控制平台上的消息和通信。

### 时序存储和数据管理模块

该模块按顺序（时间序列）存储消息总线上的所有接收和分析数据。虽然数据存储不是物联网平台的核心功能，平台外的模块或系统可以处理数据存储。但通常，通信和路由模块或消息代理本身出于特定的功能目的需要最新的数据，数据存储对于这样的需求都很方便。

对于许多物联网应用，用户更喜欢从物联网平台中提取数据，并将其存储在数据仓库中进行进一步处理。因此，它通常用于设备数据的临时存储，而不是用于大数据存储、处理和分析。

随着物联网的普及，市面上的时序数据库产品越来越多，比如Cassandra、InfluxDB等，国内的产品也日渐丰富，并且质量不输于国外产品，比如近两年比较有名的TDEngine。前面作者写过Cassandra的系列文章，可以参考。

### 规则引擎模块

这是一个非常强大的模块，规则引擎是一个执行模块，它监听整个平台上的消息总线和事件，并根据设置的规则执行操作。

例如，一个典型的规则引擎功能可能是这样的：“当下游设备发送包含alarm关键字的数据包时触发并广播报警消息。”规则引擎不断监听消息总线广播。当通信模块将解码后的数据包从下游设备传输到消息总线时，规则触发。规则引擎将另一条消息（报警）广播到消息总线。由于这一切都发生在物联网平台内和模块之间，执行效率会非常高。

规则引擎还帮助强化其他模块，比如添加解码新加入的设备协议数据的规则，因此增强了通信模块的功能。除此之外，很容易实现对其他模块、应用系统的回调。

### REST API模块

Restful API对于不需要持续或实时连接和访问的函数和程序非常有用。通常由上游程序和应用系统调用，但下游设备也可以在需要时访问这些API。

一个典型例子是使用Wi-Fi连接的温度传感器，它每15分钟发送一次数据。由于两个后续遥测数据之间的时间较长，因此不需要长链接。简单的HTTP操作可以相对高效地完成数据发送任务。在这种情况下，传感器可以通过REST API将数据发送到平台。REST API与消息代理和通信管理模块一起工作，将接收到的数据post给消息总线。它还可以使用时序数据库数据将响应发送回传感器。这个响应可能包含传感器在下一轮中以特定方式执行操作的附加信息。

REST API模块还可以支持数据聚合和批量操作功能，例如上游应用系统查询多条记录。这样，上游应用系统与核心物联网平台保持解耦，从而保持功能划分清晰，确保设计的合理性。可以内置各种基于角色的鉴权功能来访问API。

REST API模块还可以操作规则引擎，并允许应用系统在任何时间配置或触发特定的规则。也可以让下游设备能够利用相同的功能，当设备需要自动启动某些工作流来代替应用系统触发器时，这可能很方便。例如智能门锁，当房主不在家时，房门有需要房主注意的报警时，上游应用系统可以及时通知用户，然后期望用户响应进一步的操作。如果用户不响应，则应用系统可以触发预定义操作的规则。如果报警的等级相对较高，则设备可以配置为不等待用户操作或响应，而直接触发默认工作流（例如，提高安全性、发出报警声、拨打110等）。这些功能可以在设计智能设备时派上用场。

### 微服务模块

物联网平台除了具有上述功能外，还需要一定的支撑功能才能有效运行。短信或电子邮件通知、验证码、社交媒体身份验证或支付服务集成等服务是这些辅助服务。这些服务聚合在微服务模块中。

微服务的抽取(下沉)原则是，如果在平台内频繁使用某些功能，可以将其聚合成一个微服务，将其与平台解耦。一旦微服务化，它就可以暴露在平台内外的模块中复用。

### 设备管理模块

当平台接入50台以上的设备时，可能会变得难以管理。有必要为管理设备提供相应的功能。这就是设备管理模块的作用。它本质上提供了将设备作为资产进行管理的通用功能。这包括查询所有设备、它们的活动非活动状态、位置信息、电池电量、网络状况、访问密钥、遥测数据、设备详细信息、会话信息和其他内容。

设备管理模块还有助于管理设备组的OTA(在线固件升级)，系统管理员的集中监控。在某些使用情况下，设备还需要访问权限，用户可以分配到一组设备的某些访问权限。使用设备管理模块可以轻松地实现这些功能。

### 系统管理和用户管理模块

这个模块提供与设备管理模块类似的功能。不同之处在于，它为上游应用系统和用户提供了必要的功能。典型的用户管理功能（如密码、访问密钥、登录和权限）通过此块进行管理。对于上游应用和各种其他系统的集成，可以通过这一模块管理API密钥和访问权限。

虽然它看起来更像是一个应用层的功能，但将其划分到平台符合物联网平台的设计原则，这样使其与平台整体架构、下游设备及上层应用紧密集成。

### 所有模块都是必要的吗

答案是不。虽然8个模块定义了一个架构良好的物联网平台，但并非所有模块都是必需的。特定的垂直领域或行业可能会以不同的方式拆解或重组这些模块。你不需要一开始就使用所有模块，它们可能会在平台演进的生命周期中迭代添加。

核心功能模块设备接口和消息代理、消息路由和通信模块、数据存储、设备管理和规则引擎对于物联网平台的有效运行至关重要。其他模块REST API、微服务、系统管理和用户管理通常可以让系统开发和运维变得简单，但不是必要的，也不会妨碍物联网平台的功能。

在从零开发物联网平台过程中，我们会将这些功能放在次要位置，只有在时间和资源允许的情况下才进行实现。

## 物联网技术栈

![物联网技术栈](https://raw.githubusercontent.com/SaminZou/pic-repo/master/IoT/物联网技术栈.png)

# 技术选型

## 实时通讯

- websocket

- MQTT

## 存储数据

- MySQL

## 数据表设计

- id

- topic

- payload

- timestamp

