```yaml
title: RAG 调优
author: samin
date: 2025-09-02
```

预检索优化

# 查询翻译（Query Translation）

简单理解就是在真正的检索之前，先对用户查询进行“再加工”，让查询的问题变得更清晰、更准确、更适合机器去理解。

当遇到用户查询问题质量不高，表达内容模糊不清，不能覆盖所需要检索信息的所有方面时，我们就需要采取一系列如查询重写、查询分解和查询扩展等优化策略来改写用户的查询，提升查询嵌入与文档嵌入的相关性，从而达到更精确的检索效果。

## 策略

### 查询重写（Re-Phrase）

核心思想：直接通过提示词去指导大模型对用户的查询进行重写优化。将口语化、不规范的的查询转换成更适合检索的标准化表达。

优势：当用户使用口语化表达、包含错别字或表述不准确的时候，查询重写可以很容易的提升检索精确度。

### 多查询（Multi-Query）

核心思想：将用户查询的同一问题生成多种问法。这能生成多样化的查询嵌入，增加命中相关文档的概率，弥补单一问法可能存在的偏差。

优势：可以大幅提高检索精确度，尤其是针对处理模糊和多语义类型的查询问题。

### RAG 融合（RAG-Fusion）

核心思想：这种方法是一种增强型多查询，在多查询执行检索后使用倒数排序融合 (RRF) 算法，对查询返回的所有文档按相关性统一排序，而非简单合并，旨在为大模型（LLM）提供最优化、最全面的上下文。

优势：相比于简单的合并，它能够更加有效的筛选出最核心、最相关的结果。

### 查询分解（Query Decomposition）

核心思想：将用户查询拆分成多个子问题，并行或顺序处理。此方法把复杂的查询做了分解简化处理，丰富了检索上下文，从而能生成更细致、准确的答案。

优势：确保复杂问题的各个方面都得到检索，每个子问题都能找到最相关的信息，为LLM提供多维度的背景信息。

### 回溯提示（Step Back Prompting）

核心思想：当用户查询问题太过具体，将问题抽象成一个更高层次的“后退”问题，然后结合对原始问题和抽象问题的双重检索结果，为模型提供宏观与微观相结合的上下文，以生成更深刻、更全面的答案。

优势：同时获取具体信息和通用背景，提供更全面的知识基础，丰富上下文信息。结合具体细节和整体的理解，防止过度聚焦于狭窄信息。

### 假设文档嵌入（HyDE ）

核心思想：针对不佳的用户查询，先由大模型生成一个理想的“假设答案”。再用这个假设答案的嵌入去检索真实文档，以此提高检索的精准度。

优势：假设答案与目标文档语义更接近，减少查询与文档间的语义鸿沟。生成的假设答案包含更多相关概念，同样丰富上下文信息。

## 总结

• **查询重写**适合处理口语化和不规范表达
• **多查询**能够提高检索的召回率和覆盖面
• **RAG 融合**通过智能排序提供最优质的检索结果
• **查询分解**擅长处理复杂的多维度问题
• **回溯提示**结合宏观与微观视角提供全面理解
• 假设文档嵌入有效缩小查询与文档间的语义差距

# 查询路由（Query Routing）

查询路由 就像一个智能决策中心，在收到用户问题后，它会先停下来思考，而不是直接盲目地在所有资料里进行“大海捞针”。它根据用户问题的类型，决定下一步的路径怎么走：是从内部数据库A查找？还是从外部知识库B获取信息？甚至是直接上网搜索。

这个预检索的优化策略，就是为了确保系统从一开始就走在正确的道路上，大大提升了回答的精准度和效率。

## 方案

### 逻辑路由（Logical Routing）

逻辑路由就是来负责决定用户的查询问题应该交给谁来处理。当系统接收到用户查询后，通过大模型来分析和语义理解，然后从它预先掌握的所有数据源的信息和特点中，挑选出最相关、最匹配的那一个，最终将查询交给它来处理。

### 语义路由（Semantic Routing）

语义路由则是将用户的查询和系统预设的的多个提示词模板进行嵌入，计算它们的相似性，来匹配最相关提示词模板，决定最终使用哪一个提示词。

## 总结

总之，查询路由（Query Routing） 是在构建高级RAG系统比较常见的预检索优化策略。上一篇文章中提到的优化策略查询翻译（Query Translation） 侧重于将问题转换成更标准的形式，而路由则是在翻译之后选择最合适的下游资源。
无论是通过逻辑路由去匹配最相关的数据源（如向量数据库、图数据库或者关系型数据库），还是利用语义路由动态选择最优的提示词模板，查询路由都扮演着“智能导航”的角色。它核心价值在于：

1. 提升精准度：避免在不相关的数据集中进行无效搜索，将计算资源集中在最可能产生正确答案的地方。
2. 提高效率：减少检索范围和响应时间，为用户提供更流畅、更快速的交互体验。
3. 增强系统扩展性：使RAG系统能更灵活地集成和管理多个不同类型的数据源，能应对更复杂的应用场景。
   在实践中，巧妙地运用查询路由，能让你的RAG系统告别“盲目”检索，更智能、高效的实现复杂的业务场景。

# 查询构建（Query Construction）

## 技术

### Text-to-SQL -- 从自然语言到SQL转换

关键就两步：

1. 数据库描述： 你得先让大模型看明白数据库长什么样，有哪些表，表里有哪些字段。
2. 少量示例： 在提示词里给它几个标准提问的例子，它就能有样学样。

### Text-to-Cypher -- 从自然语言到图数据库查询

Text-to-Cypher 的实现主要流程是：

• 自然语言理解：你先得让它听懂你的“人话”，明白你到底想干嘛。
• Schema 匹配：你给它一张家族图谱（数据库的schema），让它把你话里提到的人和事在图谱上对号入座。
• Cypher 生成：等它都搞清楚了，它就会学着用图谱的“官方语言”，写出一句像模像样的查询。
• 查询验证与执行：它还会自己检查一下语法，确认无误后才把问题真正递出去。

### Self-Query Retriever -- 通过自然语言生成元数据过滤器

它的想法是：为什么不让用户的提问“自己告诉自己”该怎么查

它会自动从你的问题里，抠出一些关键词作为“元数据”过滤条件。比如你问“给我找找2023年关于AI的论文”，它会先用“2023”和“AI”这两个硬性条件，把海量的文档筛掉一大批，再在剩下的小范围里去做向量相似度计算。

这不就是我们人脑处理信息的方式吗？先分类，再细看。简单，但极其有效。