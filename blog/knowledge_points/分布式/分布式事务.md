```yaml
title: 分布式一致性
author: samin
date: 2021-05-15
```

# 什么是分布式事务

## 和数据库事务的区别

谈到事务，我们就会想到数据库事务，很容易就想到原子性、一致性、持久性、隔离性。

分布式事务跟数据库事务有点不一样，它是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。简单来说，分布式事务指的就是分布式系统中的事务，它的存在就是为了保证不同数据库节点的数据一致性。

## 分布式事务基础

分布式事务需要需要知道CAP理论和BASE理论。

### BASE 理论

BASE 理论， 是对CAP中AP的一个扩展，对于我们的业务系统，我们考虑牺牲一致性来换取系统的可用性和分区容错性。BASE是Basically Available(基本可用)，Soft state（软状态）,和 Eventually consistent（最终一致性）三个短语的缩写。

- 基本可用是指，通过支持局部故障而不是系统全局故障来实现的；
- Soft State表示状态可以有一段时间不同步；
- 最终一致，最终数据是一致的就可以了，而不是实时保持强一致。

## 分布式事务的几种解决方案

- 2PC(二阶段提交)方案，事务的提交分为两个阶段：准备阶段和提交执行方案。

- TCC（即Try、Confirm、Cancel），它采用了补偿机制，核心思想是：针对每个操作，都要注册一个与其对应的确认和补偿（撤销）操作。

- 本地消息表，它的核心思想就是将分布式事务拆分成本地事务进行处理。

- 最大努力通知，实现最大努力通知，可以采用MQ的ack机制。

- Saga事务，它的核心思想是将长事务拆分为多个本地短事务，由Saga事务协调器协调，如果正常结束那就正常完成，如果某个步骤失败，则根据相反顺序一次调用补偿操作。

业界目前使用本地消息表这种方案是比较多的，它的核心思想就是将分布式事务拆分成本地事务进行处理。可以看一下基本的实现流程图吧：

![本地消息表方案](https://raw.githubusercontent.com/SaminZou/pic-repo/master/MircoService/本地消息表方案.jpg)

> 对于消息发送方

- 首先需要有一个消息表，记录着消息状态相关信息。
- 业务数据和消息表在同一个数据库，即要保证它俩在同一个本地事务。
- 在本地事务中处理完业务数据和写消息表操作后，通过写消息到MQ消息队列。
- 消息会发到消息消费方，如果发送失败，即进行重试。

> 消息消费方

- 处理消息队列中的消息，完成自己的业务逻辑。
- 此时如果本地事务处理成功，则表明已经处理成功了。
- 如果本地事务处理失败，那么就会重试执行。
- 如果是业务上面的失败，给消息生产方发送一个业务补偿消息，通知进行回滚等操作。

生产方和消费方定时扫描本地消息表，把还没处理完成的消息或者失败的消息再发送一遍。如果有靠谱的自动对账补账逻辑，这种方案还是非常实用的。
