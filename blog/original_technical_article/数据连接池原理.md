```yaml
title: 数据连接池原理
author: samin
date: 2021-09-09 
```

# 数据库的连接过程 

## 数据库的连接**过程**：

1. 装载数据库驱动程序
2. 通过jdbc建立数据库连接
3. 访问数据库，执行sql
4. 断开连接

## JDBC最常用的**资源**有三类:

- Connection: 数据库连接。
- Statement: 会话声明。
- ResultSet: 结果集游标。

# 产生问题

建立连接是一个费时的活动，并且需要分配内存资源；每次连接都需要建立和断开连接；频繁的数据操作会占用很多系统资源；严重会导致服务器崩溃（内存泄露）。

# 解决方案

对连接进行管理，生成一定数量的数据库连接进行统一调配，需要的时候分发，使用完不关闭连接，而是回收存放连接，避免数据库连接和断开的操作时间消耗。

最终延伸产物——**数据库连接池**

数据库连接池的基本思想就是为数据库连接建立一个“缓冲池”。预先在缓冲池中放入一定数量的连接，当需要建立数据库连接时，只需从“缓冲池”中取出一个，使用完毕之后再放回去，及时回收数据库的游标(ResultSet)、Statement、连接 (Connection)等资源。我们可以通过设定连接池最大连接数来防止系统无尽的与数据库连接。更为重要的是我们可以通过连接池的管理机制监视数据库的连接的数量﹑使用情况，为系统开发﹑测试及性能调整提供依据。  

## 优势

1. 资源复用
2. 更快的系统响应速度
3. 新的资源分配手段（避免没有使用数据池的应用占用了数据库太多的连接资源） 
4. 统一的连接管理，避免数据库连接泄露

# 连接池的**管理**

- 把已经创建但尚未分配出去的连接按创建时间存放到一个空闲池中；
- 每当用户请求一个连接时，系统首先检查空闲池内有没有空闲连接。如果有就把建立时间最长（通过容器的顺序存放实现）的那个连接分配给他（实际是先做连接是否有效的判断，如果可用就分配给用户，如不可用就把这个连接从空闲池删掉，重新检测空闲池是否还有连接）；
- 如果没有则检查当前所开连接池是否达到连接池所允许的最大连接数（maxconn）如果没有达到，就新建一个连接，如果已经达到，就等待一定的时间（timeout）。
- 如果在等待的时间内有连接被释放出来就可以把这个连接分配给等待的用户，如果等待时间超过预定时间timeout 则返回空值（null）。
- 系统对已经分配出去正在使用的连接只做计数，当使用完后再返还给空闲池。
- 对于空闲连接的状态，可开辟专门的线程定时检测，这样会花费一定的系统开销，但可以保证较快的响应速度。也可采取不开辟专门线程，只是在分配前检测的方法。
- 释放空闲时间超过最大空闲时间的数据库连接来避免因为没有释放数据库连接而引起的数据库连接遗漏。

# 连接池的**配置**

- *最小连接数*：系统启动时连接池所创建的连接数。如果创建过多，则系统启动就慢，但创建后系统的响应速度会很快；如果创建过少，则系统启动的很快，响应起来却慢。这样，可以在开发时，设置较小的最小连接数，开发起来会快，而在系统实际使用时设置较大的，因为这样对访问客户来说速度会快些。  

- *最大连接数*：连接池中允许连接的最大数目，具体设置多少，要看系统的访问量，可通过反复测试，找到最佳点。

# 连接池需要**考虑的问题**

1. 用加锁解决分配时候造成的并发问题;
2. 多用户问题和多数据库服务器;
3. 事务处理；
4. 连接池的分配释放；
5. 连接池的配置与维护；

# **连接池的运作**

假设设置了最小和最大的连接为10，20，那么应用一旦启动则首先打开10个数据库连接，但注意此时数据库连接池的正在使用数字为0--因为你并没有使用这些连接，而空闲的数量则是10。然后你开始登录，假设登录代码使用了一个连接进行查询，那么此时数据库连接池的正在使用数字为1、空闲数为9，这并不需要从数据库打开连接--因为连接池已经准备好了10个给你留着呢。登录结束了，当前连接池的连接数量是多少？当然是0，因为那个连接随着事务的结束已经返还给连接池了。然后同时有11个人在同一秒进行登录，会发生什么：连接池从数据库新申请（打开）了一个连接，连同另外的10个一并送出，这个瞬间连接池的使用数是11个，不过没关系正常情况下过一会儿又会变成0。如果同时有21个人登录呢？那第21个人就只能等前面的某个人登录完毕后释放连接给他。这时连接池开启了20个数据库连接--虽然很可能正在使用数量的已经降为0，那么20个连接会一直保持吗？当然不，连接池会在一定时间内关闭一定量的连接还给数据库，在这个例子里数字是20-10=10，因为只需要保持最小连接数就好了，而这个时间周期也是连接池里配置的。

参考：  
[http://blog.csdn.net/shuaihj/article/details/14223015](http://blog.csdn.net/shuaihj/article/details/14223015)  
[https://www.cnblogs.com/wym789/p/6374440.html](https://www.cnblogs.com/wym789/p/6374440.html)  
[http://blog.csdn.net/u011088260/article/details/53311165](http://blog.csdn.net/u011088260/article/details/53311165)