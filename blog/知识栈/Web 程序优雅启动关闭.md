```yaml
title: Web 程序优雅启动关闭 
author: samin
date: 2022-03-26
```

# 说明

本文讨论的主要是在 RPC 模型中的服务提供者，如何进行优雅启动和优雅关闭

# 优雅启动

## 目的

1. 预热（warmup），现在大部分系统都有做大量缓存
2. 未知可用性，逐渐加大流量防止一次性大量的流量崩溃

## 两种实现

1. 服务提供方在启动的时候，主动将启动时间发送给注册中心
2. 注册中心检测服务提供方的请求注册时间作为启动时间

## 原理

调用方通过服务发现获取服务提供方的启动时间，然后进行降权，减少被负载均衡选择的概率，从而实现预热的过程

# 优雅关闭

## 调用服务提供方可能存在的关闭情况

- 目标已经下线

- 目标正在关闭

## 解决方案

设置请求”挡板“

## 实现

当服务提供方正在关闭，可以直接返回一个特定异常给调用方。调用方把这个节点从健康列表挪出，并把其他请求自动重试到其他节点。如果需要完善，可以再加上主动通知机制。