```yaml
title: 高可用入门
author: samin
date: 2021-12-29
```

# 常用工具

haproxy、keepalived、nginx、LVS

# 保障高可用的手段

LB / HA / HPC

# 负载均衡

## LVS 是什么

> https://juejin.cn/post/6966411996589719583

## HAProxy 是什么

## Nginx 是什么

## Keepalived

### 是什么

Keepalived一个基于VRRP 协议来实现的 LVS 服务高可用方案，可以利用其来解决单点故障。

一个 LVS 服务会有 2 台服务器运行 Keepalived，一台为主服务器（ MASTER ），一台为备份服务器（ BACKUP ），但是对外表现为一个虚拟IP，主服务器会发送特定的消息给备份服务器，当备份服务器收不到这个消息的时候，即主服务器宕机的时候， 备份服务器就会接管虚拟 IP，继续提供服务，从而保证了高可用性。

### 作用

Keepalived 提供了很好的高可用性保障服务，它可以检查服务器的状态，如果有服务器出现问题，Keepalived 会将其从系统中移除，并且同时使用备份服务器代替该服务器的工作，当这台服务器可以正常工作后，Keepalived 再将其放入服务器群中，这个过程是 Keepalived 自动完成的，不需要人工干涉，我们只需要修复出现问题的服务器即可。

### 原理

#### 基于 VRRP 协议的理解

Keepalived 是以 VRRP( Virtual Router Redundancy Protocol，即虚拟路由冗余协议 ) 协议为基础实现的

虚拟路由冗余协议，可以认为是实现路由器高可用的协议，即将N台提供相同功能的路由器组成一个路由器组，这个组里面有一个master 和多个 backup，master 上面有一个对外提供服务的 VIP(Virtual IP Address)（该路由器所在局域网内其他机器的默认路由为该 vip），master 会发组播，当 backup 收不到 vrrp 包时就认为 master 宕掉了，这时就需要根据 VRRP 的优先级来选举一个 backup 当 master。这样的话就可以保证路由器的高可用了

keepalived 主要有三个模块，分别是core、check 和 vrrp。core 模块为keepalived的核心，负责主进程的启动、维护以及全局配置文件的加载和解析。check 负责健康检查，包括常见的各种检查方式。vrrp 模块是来实现 VRRP 协议的

#### 基于网络分层的理解

以检测 web 服务器为例，Keepalived 从3个层次来检测服务器的状态

Layer3 、Layer4 以及 Layer7 工作在 IP/TCP 协议栈的IP层，TCP层，及应用层

- Layer3

  Keepalived使用Layer3的方式工作时，Keepalived会定期向服务器群中的服务器发送一个ICMP的数据包（既我们平时用的Ping程序）,如果发现某台服务的IP地址没有激活，Keepalived 便报告这台服务器失效，并将它从服务器群中剔除，这种情况的典型例子是某台服务器被非法关机。Layer3 的方式是以服务器的IP地址是否有效作为服务器工作正常与否的标准。

- Layer4

  如果您理解了Layer3的方式，Layer4就容易了。Layer4主要以TCP 端口的状态来决定服务器工作正常与否。如 web server 的服务端口一般是80，如果 Keepalived 检测到80端口没有启动，则 Keepalived 将把这台服务器从服务器群中剔除。

- Layer7
  
  Layer7 就是工作在具体的应用层了，比Layer3,Layer4要复杂一点，在网络上占用的带宽也要大一些。Keepalived 将根据用户的设定检查服务器程序的运行是否正常，如果与用户的设定不相符，则 Keepalived 将把服务器从服务器群中剔除。

### Keepalived 基本使用

> https://juejin.cn/post/6844904167585087501

## HAProxy 和 Nginx 的区别

## 目前关于网站架构一般比较合理流行的架构方案

- Web 前端采用 Nginx/HAProxy + Keepalived 作负载均衡器；

- 后端采用 MySQ L数据库一主多从和读写分离，采用 LVS + Keepalived 的架构。（ MySQL自带主从设置，如何理解用LVS？）

# Keepalived + Nginx 实现高可用

https://juejin.cn/post/6844904022688661512

# LVS + Keepalived + Nginx

https://juejin.cn/post/6986812754761875470