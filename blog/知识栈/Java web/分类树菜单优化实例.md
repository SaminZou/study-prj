```yaml
title: 分类树菜单优化实例
author: samin
date: 2023-12-20
```

# 背景

- 基于 springboot 的 thymeleaf 渲染

- 电商的分类树导航菜单查询功能

# 快速交付版本

前端开发好 HTML，转换为 Thymeleaf 模板文件，调用后端接口，直接从数据库中获取数据，程序组装分类树后进行动态绑定把内容返回给用户。

# 第一次优化

> 加 Redis 缓存

访问接口 -> 从 Redis 获取数据（找不到缓存从数据库读并缓存） -> 组装分类树渲染后返回

# 第二次优化

问题：隔一段时间就出现一次首页访问很慢的情况

定位：Redis 缓存失效从数据库直接获取数据的时候

增加定时任务，每隔一段时间（结合 Redis 过期时间具体配置）主动从数据库中获取数据更新缓存

# 第三次优化

问题：上线后，QPS 大于 100 的时候出现请求瓶颈

定位：所有请求直接从 Redis 中获取数据造成 IO 瓶颈

引入 caffine 加入 `内存缓存`，每个服务器节点请求 Redis 后把数据存入本地内存，返回数据。

> 优化后的访问路径为：访问接口 -> 从本地缓存获取数据（如果失败，从 Redis 获取数据） -> 组装分类树渲染后返回
> 此次优化后需要注意数据一致性问题

# 第四次优化

问题：分类数据返回缓慢

定位：分类数据太多，上万个分类数据导致传输时间过长

开启 Nginx 的 Gzip 功能，1 MB 可以压缩成 100 KB

# 第五次优化

问题：Redis 缓存中存在大 Key

定位：分类树数据使用 key/value 存储导致

修改数据结构缩减分类数据结构字段，修改 Redis 的存储方式为 byte 数组，解决 Redis 大 Key 问题

